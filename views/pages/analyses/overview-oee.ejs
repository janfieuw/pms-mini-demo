<!-- views/pages/analyses/overview-oee.ejs -->
<style>
  .page-card{
    background:transparent!important;
    box-shadow:none!important;
    border:none!important;
    margin:0!important;
    padding:0!important;
  }
  main, body{
    margin:0!important;
    padding:0!important;
  }
</style>

<%
  const avg   = typeof avgOee === 'number' ? avgOee : 0;
  const upper = avg + 15; // +15% of meer => groen
  const lower = avg - 15; // -15% of meer => rood
%>

<div style="max-width:1100px;margin:0 auto 24px auto;background:#ffffff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,0.12);padding:24px;border:1px solid rgba(0,0,0,0.08);">

  <h2>ANALYSES • OVERVIEW OEE</h2>

  <%
  // Bepaal automatisch de vroegste en laatste datum in de data
  let earliest = "";
  let latest = "";

  if (rows && rows.length) {
    const dates = rows
      .map(r => new Date(r.startLabel))
      .filter(d => !isNaN(d));

    if (dates.length) {
      const min = new Date(Math.min.apply(null, dates));
      const max = new Date(Math.max.apply(null, dates));

      earliest = min.toISOString().substring(0, 10);
      latest   = max.toISOString().substring(0, 10);
    }
  }
%>

<!-- FILTER FORM -->
<form method="GET" action="/analyses/overview-oee"
      style="margin:16px 0 24px 0; display:flex; gap:16px; align-items:flex-end;">

  <div style="display:flex; flex-direction:column;">
    <label style="font-size:11px; color:#555;">Start date</label>
    <input type="date" name="start"
           value="<%= earliest %>"
           style="padding:6px 8px; border-radius:6px; border:1px solid #ccc;" />
  </div>

  <div style="display:flex; flex-direction:column;">
    <label style="font-size:11px; color:#555;">End date</label>
    <input type="date" name="end"
           value="<%= latest %>"
           style="padding:6px 8px; border-radius:6px; border:1px solid #ccc;" />
  </div>

  <button type="submit"
          style="padding:8px 16px; background:#000; color:#fff; border:none; border-radius:6px; cursor:pointer;">
    Filter
  </button>
</form>


  <!-- Kader met gemiddeld OEE -->
  <div style="margin:16px 0 24px 0; padding:16px; border-radius:12px; background:#ededed; display:flex; flex-direction:column; gap:4px;">
    <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em; color:#555;">
      Average OEE (all shifts)
    </div>
    <div style="font-size:24px; font-weight:700;">
      <%= avg.toFixed(2) %>%
    </div>
    <div style="font-size:11px; color:#777;">
      Green ≥ <%= upper.toFixed(2) %>%  •  Red ≤ <%= lower.toFixed(2) %>%
    </div>
  </div>

  <% if (!(rows && rows.length)) { %>
    <p class="muted">No OEE data yet.</p>
  <% } else { %>
    <div style="overflow:auto;">
      <table style="width:100%; border-collapse:collapse; font-size:10px;">
        <thead>
          <tr style="background:#f7f7f7;">
            <th style="text-align:left;  padding:8px; border-bottom:1px solid #ddd;">#</th>
            <th style="text-align:left;  padding:8px; border-bottom:1px solid #ddd;">OPERATOR</th>
            <th style="text-align:left;  padding:8px; border-bottom:1px solid #ddd;">START TIME</th>
            <th style="text-align:left;  padding:8px; border-bottom:1px solid #ddd;">END TIME</th>
            <th style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">OEE (%)</th>
          </tr>
        </thead>
        <tbody>
          <% rows.forEach((r, idx) => {
               const valRaw = (r && (r.oee ?? r.OEE ?? r.oeePercent ?? r.oee_percentage)) || 0;
               const val    = Number(valRaw) || 0;

               let color = '#000000';
               let weight = '400';

               if (val >= upper) {
                 color = '#0b7c17'; // groen
                 weight = '700';
               } else if (val <= lower) {
                 color = '#b00020'; // rood
                 weight = '700';
               }
          %>
            <tr>
              <td style="padding:8px; border-bottom:1px solid #eee;"><%= idx + 1 %></td>
              <td style="padding:8px; border-bottom:1px solid #eee;"><%= r.operator || '' %></td>
              <td style="padding:8px; border-bottom:1px solid #eee; white-space:nowrap;"><%= r.startLabel || '' %></td>
              <td style="padding:8px; border-bottom:1px solid #eee; white-space:nowrap;"><%= r.endLabel || '' %></td>
              <td style="padding:8px; border-bottom:1px solid #eee; text-align:right; color:<%= color %>; font-weight:<%= weight %>;">
                <%= val.toFixed(2) %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>
</div>
