<!-- views/pages/bulk/bulk-registratie.ejs -->

<div class="card shadow-sm mb-4">

  <!-- HEADER -->
  <div class="card-header">
    <h1 class="h3 mb-1">BULK • REGISTRATIE</h1>
    <p class="text-muted mb-0"></p>
  </div>

  <div class="card-body">

    <% if (error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <form action="/bulk/registratie" method="POST">
      <div class="row g-3">

        <!-- Customer (uit BB_CUSTOMERS) -->
        <div class="col-md-6">
          <label for="customer" class="form-label fw-semibold">Customer:</label>
          <select
            id="customer"
            name="customer"
            class="form-select"
            required
          >
            <option value="" disabled <%= !old.customer ? 'selected' : '' %>>-- choose --</option>
            <% (BB_CUSTOMERS || []).forEach(function(c) { %>
              <option value="<%= c %>" <%= (old.customer === c ? 'selected' : '') %>><%= c %></option>
            <% }); %>
          </select>
        </div>

        <!-- Silo -->
        <div class="col-md-6">
          <label for="silo" class="form-label fw-semibold">Silo:</label>
          <select
            id="silo"
            name="silo"
            class="form-select"
            required
          >
            <option value="" disabled <%= !old.silo ? 'selected' : '' %>>-- choose --</option>
            <option value="710" <%= old.silo === '710' ? 'selected' : '' %>>710</option>
            <option value="720" <%= old.silo === '720' ? 'selected' : '' %>>720</option>
          </select>
        </div>

        <!-- Gewicht -->
        <div class="col-md-6">
          <label for="kg" class="form-label fw-semibold">Weight (kg):</label>
          <input
            type="number"
            step="0.1"
            id="kg"
            name="kg"
            class="form-control"
            value="<%= old.kg || '' %>"
            required
          >
        </div>

        <!-- CMR -->
        <div class="col-md-6">
          <label for="cmr" class="form-label fw-semibold">CMR:</label>
          <input
            type="text"
            id="cmr"
            name="cmr"
            class="form-control"
            value="<%= old.cmr || '' %>"
          >
        </div>

        <!-- AANKOOPORDER -->
        <div class="col-md-6">
          <label for="purchase_order" class="form-label fw-semibold">AANKOOPORDER:</label>
          <input
            type="text"
            id="purchase_order"
            name="purchase_order"
            class="form-control"
            value="<%= old.purchase_order || '' %>"
          >
        </div>

        <!-- LEVERINGSBON -->
        <div class="col-md-6">
          <label for="delivery_note" class="form-label fw-semibold">LEVERINGSBON:</label>
          <input
            type="text"
            id="delivery_note"
            name="delivery_note"
            class="form-control"
            value="<%= old.delivery_note || '' %>"
          >
        </div>

        <!-- Date -->
        <div class="col-md-6">
          <label for="bulk_date" class="form-label fw-semibold">Date:</label>
          <input
            id="bulk_date"
            name="date"
            type="text"
            inputmode="numeric"
            maxlength="10"
            placeholder="DD/MM/YYYY"
            required
              pattern="^(0?[1-9]|[12]\d|3[01])\/(0?[1-9]|1[0-2])\/\d{4}$"
            title="Gebruik formaat DD/MM/YYYY"
            class="form-control"
            style="border-color:#e0c36c;background:#FFF4CD; text-align:center; max-width:160px;"
            value="<%= old.date || '' %>"
          >
        </div>

        <!-- Time -->
        <div class="col-md-6">
          <label for="bulk_time" class="form-label fw-semibold">Time:</label>
          <input
            id="bulk_time"
            name="time"
            type="text"
            inputmode="numeric"
            maxlength="5"
            placeholder="HH:MM"
            required
           pattern="^([01]\d|2[0-3]):[0-5]\d$"

            title="Gebruik formaat HH:MM (00–23:00–59)"
            class="form-control"
            style="border-color:#e0c36c ;background:#FFF4CD; text-align:center; max-width:120px;"
            value="<%= old.time || '' %>"
          >
        </div>

        <!-- Remark -->
        <div class="col-12">
          <label for="remark" class="form-label fw-semibold">Remark:</label>
          <textarea
            id="remark"
            name="remark"
            rows="2"
            class="form-control"
          ><%= old.remark || '' %></textarea>
        </div>

      </div>

      <br>

      <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="submit"
          style="
            background:#fdc500;
            color:#000;
            border:none;
            border-radius:9999px;
            padding:8px 18px;
            font-weight:500;
            text-transform:uppercase;
            box-shadow:0 1px 3px rgba(0,0,0,.15);
            cursor:pointer;
            font-size:11px;
            white-space:nowrap;
            transition:background .12s ease,color .12s ease,opacity .12s ease;
          "
          onmouseover="this.style.background='#000'; this.style.color='#fff';"
          onmouseout="this.style.background='#fdc500'; this.style.color='#000';"
        >
          REGISTREER BULK
        </button>
      </div>

    </form>
  </div>
</div>

<script>
  (function () {
    function toHHMM(v) {
      v = (v || '').replace(/\\D/g, '').slice(0, 4);
      if (v.length >= 3) v = v.slice(0, 2) + ':' + v.slice(2);
      return v;
    }

    function toDDMMYYYY(v) {
      v = (v || '').replace(/\\D/g, '').slice(0, 8);
      if (v.length >= 5) return v.slice(0, 2) + '/' + v.slice(2, 4) + '/' + v.slice(4);
      if (v.length >= 3) return v.slice(0, 2) + '/' + v.slice(2);
      return v;
    }

    var t = document.getElementById('bulk_time');
    var dEl = document.getElementById('bulk_date');

    var now = new Date();
    function pad(n){ return String(n).padStart(2,'0'); }

    if (t && !t.value) {
      t.value = pad(now.getHours()) + ':' + pad(now.getMinutes());
    }
    if (dEl && !dEl.value) {
      dEl.value = pad(now.getDate()) + '/' + pad(now.getMonth() + 1) + '/' + now.getFullYear();
    }

    if (t) {
      t.addEventListener('input', function (e) {
        e.target.value = toHHMM(e.target.value);
      });
      t.addEventListener('blur', function (e) {
        var m = e.target.value.match(/^(\\d{1,2})(?::?(\\d{1,2}))?$/);
        if (!m) { e.target.value = ''; return; }
        var h = Math.min(parseInt(m[1] || '0', 10), 23);
        var mn = Math.min(parseInt(m[2] || '0', 10), 59);
        e.target.value = pad(h) + ':' + pad(mn);
      });
    }

    if (dEl) {
      dEl.addEventListener('input', function (e) {
        e.target.value = toDDMMYYYY(e.target.value);
      });
      dEl.addEventListener('blur', function (e) {
        var m = e.target.value.match(/^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})$/);
        if (!m) return;
        var dd = Math.max(1, Math.min(parseInt(m[1], 10), 31));
        var mm = Math.max(1, Math.min(parseInt(m[2], 10), 12));
        var yyyy = parseInt(m[3], 10);
        e.target.value = pad(dd) + '/' + pad(mm) + '/' + yyyy;
      });
    }
  })();
</script>
