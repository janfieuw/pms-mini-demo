<style>
  .messages-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
  }

  .messages-table td {
    padding: 4px 6px;
    vertical-align: top;
  }

  .msg-main-cell {
    width: 100%;
  }

  .msg-icons-cell {
    width: 65px;
    text-align: center;
    white-space: nowrap;
  }

  .message-block {
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 6px 8px;
  }

  .msg-header-row {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 4px;
  }

  .msg-meta {
    font-family: 'Roboto Mono', monospace;
    font-size: 11px;
    font-weight: 600;
  }

  .msg-label-row {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 4px;
    padding-bottom: 0;
  }

  .msg-body {
    margin-top: 0;
    padding-top: 0;
    font-size: 11px;
    white-space: pre-wrap;
  }

  /* Info labels (B0110, B0210, â€¦) */
  .info {
    display:inline-flex;align-items:center;justify-content:center;
    width:145px!important;min-width:145px!important;max-width:145px!important;
    font-family:'Roboto Mono',monospace;font-size:11px;
    height:24px;border-radius:4px;
    background:#ebebeb;color:#2c2c2c;border:0;margin:2px 3px;
    white-space:nowrap;
  }

  /* Category â†’ moet vooraan staan */
  .topic-type-tag {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:145px !important;
    min-width:145px !important;
    max-width:145px !important;
    font-family:'Roboto Mono', monospace;
    font-size:11px;
    height:24px;
    border-radius:4px;
    background-color:#f9b9aa; /* roze */
    color:#2c2c2c;
    border:none;
    margin:2px 3px;
    white-space:nowrap;
  }

  .icon-btn{
    width:28px;height:28px;
    border:1px solid #ddd;
    background:#ffffff;
    border-radius:6px;
    padding:0;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .icon-btn:hover{ background:#fdc500; }
  .icon-btn.active{ background:#fdc500; }
  .icon-btn i{ font-size:11px; }

  .attachments-row {
    margin-top:6px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
</style>

<section class="card">

<%
  function fmtDateTime(m){
    const pad = n => n < 10 ? '0' + n : n;
    const d = m.createdAt ? new Date(m.createdAt) : null;
    const valid = d && !isNaN(d);
    const dateStr = valid
      ? `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`
      : '';
    const timeStr = m.time || (valid ? `${pad(d.getHours())}:${pad(d.getMinutes())}` : '');
    return [dateStr, timeStr].filter(Boolean).join(' - ');
  }
%>

<h1 style="margin-bottom:2px;">TEAMS â€¢ TOPICS</h1>
<span style="font-family:'Roboto Mono', monospace;font-size:11px;color:#646464;">
  All topics are must-reads. Tick the checkbox when you have read the topic and press ACKNOWLEDGE.
</span>
<br><br>

<form method="post" action="/team/topics/acknowledge">

  <div class="feed">

    <% let hasUnacked = false; %>

    <% if (items && items.length) { %>
      <table class="messages-table">
        <tbody>
        <% items.forEach(function(m){
             const inNB = Array.isArray(notebooks) && notebooks.includes(m.id);
             const ackBy = Array.isArray(m.ackBy) ? m.ackBy : [];
             const acked = currentUser && ackBy.includes(currentUser.code);
        %>
          <% if (!acked) { hasUnacked = true; %>
          <tr>

            <td class="msg-main-cell">
              <div class="message-block">

                <div class="msg-header-row">
                  <input type="checkbox"
                         name="ids"
                         value="<%= m.id %>"
                         style="transform:scale(1.3);margin-right:6px;">
                  <span class="msg-meta">
                    <%= m.user %> - <%= fmtDateTime(m) %> :
                  </span>
                </div>

                <div class="msg-label-row">

                  <!-- 1ï¸âƒ£ EERSTE LABEL = CATEGORIE -->
                  <% if (m.topicType) { %>
                    <span class="topic-type-tag"><%= m.topicType %></span>
                  <% } %>

                  <!-- 2ï¸âƒ£ DAN ALLE INFO LABELS -->
                  <% (m.infoLabels || []).forEach(function(l){ %>
                    <span class="info"><%= l %></span>
                  <% }); %>

                </div>

                <% if (m.message) { %>
                  <div class="msg-body"><%= m.message %></div>
                <% } %>

                <% if (m.attachments && m.attachments.length) { %>
                  <div class="attachments-row">
                    <% m.attachments.forEach(function(a){ %>
                      <% if (a.mime && a.mime.startsWith('image/')) { %>
                        <a href="<%= a.href %>" target="_blank" rel="noopener"
                           style="border:1px solid #e6e6ee;border-radius:8px;overflow:hidden;display:inline-block;">
                          <img src="<%= a.href %>" alt="<%= a.name %>"
                               style="display:block;max-width:77px;max-height:56px;object-fit:contain;">
                        </a>
                      <% } else { %>
                        <a href="<%= a.href %>" target="_blank" rel="noopener"
                           style="display:inline-flex;align-items:center;border:1px solid #e6e6ee;border-radius:8px;text-decoration:none;padding:4px 6px;font-size:11px;">
                          ðŸ“„ <span style="margin-left:6px;word-break:break-all;"><%= a.name %></span>
                        </a>
                      <% } %>
                    <% }); %>
                  </div>
                <% } %>

              </div>
            </td>

            <td class="msg-icons-cell">
              <button
                class="icon-btn <%= inNB ? 'active' : '' %>"
                title="<%= inNB ? 'Remove from notebook' : 'Add to notebook' %>"
                type="submit"
                name="id"
                value="<%= m.id %>"
                formmethod="post"
                formaction="<%= inNB ? '/logbook/remove-notebook' : '/team/topics/add-notebook' %>">
                <i data-lucide="notebook-pen"></i>
              </button>
            </td>

          </tr>
          <% } %>
        <% }); %>
        </tbody>
      </table>
    <% } %>

    <% if (!items || !items.length || !hasUnacked) { %>
      <p class="muted" style="font-size:11px;">No topics to read.</p>
    <% } %>

  </div>

  <% if (hasUnacked) { %>
    <div style="text-align:right;margin-top:15px;">
      <button type="submit"
              class="btn btn-dark submit"
              style="font-family:'Roboto Mono', monospace;">
        ACKNOWLEDGE
      </button>
    </div>
  <% } %>

</form>

</section>
