<div class="page-shadow-wrapper">
  <div class="wms-container">

    <!-- Titel + uitleg -->
    <div class="wms-page-header">
      <h1>BIG BAGS • DISCHARGE</h1>
  
    </div>

    <!-- Controlepaneel: keuze hoeveelheid, silo, lot en gekozen locatie -->
    <div class="wms-card">

      <!-- target="_blank" => label in nieuw tabblad -->
      <form id="bbDischargeForm"
            method="POST"
            action="/bb/discharge/print-label"
            target="_blank"
            rel="noopener noreferrer">
        <div class="wms-form-grid">

          <!-- Gekozen locatievak -->
          <div class="wms-form-group">
            <label for="locationCode">First select a free/grey floor section.</label>
            <input 
              type="text" 
              id="locationCode" 
              name="locationCode" 
              readonly 
              placeholder="..." 
              required
            >
          </div>

          <!-- Hoeveelheid -->
          <div class="wms-form-group">
            <label>Quantity (kg)</label>
            <div class="wms-radio-group">
              <label>
                <input type="radio" name="quantityKg" value="1000" checked>
                1000 kg
              </label>
              <label>
                <input type="radio" name="quantityKg" value="1100">
                1100 kg
              </label>
              <label>
                <input type="radio" name="quantityKg" value="1200">
                1200 kg
              </label>
            </div>
          </div>

          <br>

          <!-- Origin / silo -->
          <div class="wms-form-group">
            <label for="originSilo">Origin (silo)</label>
            <select id="originSilo" name="originSilo" required>
              <option value="">-- choose silo --</option>
              <option value="SILO 710">SILO 710</option>
              <option value="SILO 720">SILO 720</option>
            </select>
          </div>

          <!-- Lotnummer dropdown (nieuw > oud) -->
          <div class="wms-form-group">
            <label for="lotNumber">Batch</label>
            <select id="lotNumber" name="lotNumber" required>
              <option value="">-- choose batch --</option>
              <% if (lots && lots.length > 0) { %>
                <% lots.forEach(function(lot) { %>
                  <option value="<%= lot.code || lot %>">
                    <%= lot.code || lot %>
                  </option>
                <% }) %>
              <% } else { %>
                <!-- fallback als er nog geen data doorgestuurd wordt -->
                <option value="AP-25081701">AP-25081701</option>
              <% } %>
            </select>
          </div>

          <!-- Taalkeuze voor label -->
          <div class="wms-form-group">
            <label for="labelLang">Label language</label>
            <select id="labelLang" name="labelLang">
              <option value="nl">Nederlands</option>
              <option value="en">English</option>
              <option value="es">Español</option>
              <option value="fr">Français</option>
              <option value="da">Dansk</option>
              <option value="cs">Čeština</option>
              <option value="it">Italiano</option>
            </select>
          </div>

          <!-- Logo-keuze -->
          <div class="wms-form-group">
            <label for="logoChoice">Logo</label>
            <select id="logoChoice" name="logoChoice">
              <!-- value = bestandsnaam in /public/grafisch -->
              <option value="rs-logo.png">RS:LOGO</option>
              <option value="pl-logo.png">PL:LOGO</option>
              <option value="no-logo.png">NO:LOGO</option>
            </select>
          </div>

          <br>

        </div>

           <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="submit"
          style="
            background:#fdc500;
            color:#000;
            border:none;
            border-radius:9999px;
            padding:8px 18px;
            font-weight:500;
            text-transform:uppercase;
            box-shadow:0 1px 3px rgba(0,0,0,.15);
            cursor:pointer;
            font-size:11px;
            white-space:nowrap;
            transition:background .12s ease,color .12s ease,opacity .12s ease;
          "
          onmouseover="this.style.background='#000'; this.style.color='#fff';"
          onmouseout="this.style.background='#fdc500'; this.style.color='#000';"
        >
          Confirm &amp; print label
          </button>
        </div>
      </form>

      <br>

      <!-- Legende -->
      <div class="bb-legend">
        <span class="bb-legend-item">
          <span class="bb-status-box bb-free"></span> Empty
        </span>
        <span class="bb-legend-item">
          <span class="bb-status-box bb-occupied"></span> Occupied (BB with free stock)
        </span>
        <span class="bb-legend-item">
          <span class="bb-status-box bb-allocated"></span> Allocated (BB linked to customer)
        </span>
      </div>
    </div>

    <br>

    <!-- Magazijnrooster 26 × (A..L) -->
    <div class="wms-card wms-card-margin-top">
      <div class="wms-card-header">
      <% 
        // Diepte-kolommen A..L
        const cols = ['A','B','C','D','E','F','G','H','I','J','K','L']; 
      %>

      <% if (!slots || slots.length === 0) { %>
        <p class="wms-table-empty">
          No location data available yet. (Grid shows structure only – backend kan later de statuses invullen.)
        </p>
      <% } %>

      <div class="bb-grid-wrapper">
        <table class="bb-grid-table">
          <thead>
            <tr>
              <th class="bb-grid-corner">Row</th>
              <% cols.forEach(function(col) { %>
                <th><%= col %></th>
              <% }) %>
            </tr>
          </thead>
          <tbody>
            <% for (let row = 1; row <= 26; row++) { %>
              <tr>
                <th class="bb-grid-row-label"><%= row %></th>
                <% cols.forEach(function(col) { 
                    const code = row + col; // bv. 1A, 1B, ...
                    let slot = null;
                    if (slots && slots.length) {
                      slot = slots.find(s => (s.code === code) || (String(s.row) === String(row) && String(s.col).toUpperCase() === col));
                    }
                    const status = slot ? (slot.status || 'free') : 'free';
                    const lot   = slot && slot.lot ? slot.lot : '';
                    const qty   = slot && slot.quantityKg ? slot.quantityKg : '';
                %>
                  <td
                    class="bb-slot bb-<%= status %>"
                    data-code="<%= code %>"
                    data-status="<%= status %>"
                    title="<%= code %><% if (lot) { %> – <%= lot %> (<%= qty %> kg)<% } %>"
                  >
                    <div class="bb-slot-inner">
                      <span class="bb-slot-code"><%= code %></span>
                      <% if (lot) { %>
                        <span class="bb-slot-lot"><%= lot %></span>
                      <% } %>
                      <% if (qty) { %>
                        <span class="bb-slot-qty"><%= qty %> kg</span>
                      <% } %>
                    </div>
                  </td>
                <% }) %>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

  </div> <!-- /.wms-container -->
</div> <!-- /.page-shadow-wrapper -->

<!-- CSS enkel voor deze pagina -->
<style>
  .page-shadow-wrapper {
    max-width: 90%;
    margin: 0 auto;
    padding: 25px 40px;
    background: #ffffff;
    box-shadow: 0 0 25px rgba(0,0,0,0.08);
    border-left: 1px solid #e6e6e6;
    border-right: 1px solid #e6e6e6;
    min-height: calc(100vh - 140px);
  }

  .wms-container {
    width: 100%;
    margin: 0;
  }

  .bb-legend {
    margin-top: 1.2rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    font-size: 1rem;
  }
  .bb-legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .bb-status-box {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 1px solid #bbb;
  }
  .bb-free { background-color: #e0e0e0; }
  .bb-occupied { background-color: #b4e3b4; }
  .bb-allocated { background-color: #ffd8a8; }

  .bb-grid-wrapper {
    width: 100%;
    overflow-x: auto;
    padding: 0.5rem 0;
  }

  .bb-grid-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 0.95rem;
    background: white;
    border: 1px solid #ccc;
  }
  .bb-grid-table th,
  .bb-grid-table td {
    border: 1px solid #d5d5d5;
    text-align: center;
    padding: 0.4rem;
    vertical-align: middle;
  }
  .bb-grid-table th {
    background: #f0f0f0;
    font-weight: 700;
  }

  .bb-grid-corner {
    width: 55px;
  }
  .bb-grid-row-label {
    width: 55px;
    background: #f5f5f5 !important;
    font-size: 1rem;
    font-weight: 700;
  }

  .bb-slot {
    cursor: pointer;
    transition: 0.2s;
    padding: 0 !important;
  }
  .bb-slot-inner {
    min-height: 42px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 3px;
  }
  .bb-slot-code {
    font-size: 0.9rem;
    font-weight: 700;
  }
  .bb-slot-lot {
    font-size: 0.75rem;
    max-width: 100%;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .bb-slot-qty {
    font-size: 0.75rem;
    font-weight: 600;
  }

  .bb-free { background-color: #f7f7f7; }
  .bb-free:hover { background-color: #e9e9e9; }

  .bb-occupied { background-color: #c9efc9; }
  .bb-occupied:hover { background-color: #b8e6b8; }

  .bb-allocated { background-color: #ffe6c7; }
  .bb-allocated:hover { background-color: #ffdcb3; }

  .bb-slot.selected {
    outline: 3px solid #1a1a1a;
    background: #fffbe0 !important;
  }

  .wms-card {
    width: 100%;
  }

  .wms-form-grid {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }

  #locationCode {
    width: 5%;
    text-align: center;
  }

  .wms-form-actions {
    margin-top: 1rem;
    text-align: left;
  }

  .wms-radio-group label {
    font-size: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: -5px;
  }
</style>

<script>
  // zachtjes naar boven scrollen na selectie
  function scrollToTopSlow() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }

  (function() {
    const slots         = document.querySelectorAll('.bb-slot');
    const locationInput = document.getElementById('locationCode');
    const form          = document.getElementById('bbDischargeForm');
    const lotSelect     = document.getElementById('lotNumber');
    let selectedCell    = null;

    // Klik op vakje
    slots.forEach(function(cell) {
      cell.addEventListener('click', function() {
        const status = cell.getAttribute('data-status');
        if (status !== 'free') {
          alert('Only FREE locations can be selected.');
          return;
        }

        if (selectedCell) {
          selectedCell.classList.remove('selected');
        }
        selectedCell = cell;
        selectedCell.classList.add('selected');

        const code = cell.getAttribute('data-code');
        if (locationInput) {
          locationInput.value = code;
        }

        // na kiezen van een vakje langzaam naar boven
        scrollToTopSlow();
      });
    });

    // Bij printen van label: vakje visueel omzetten naar 'occupied'
    // én lot + kg invullen
    if (form) {
      form.addEventListener('submit', function(e) {
        // Als er geen vakje gekozen is → formulier blokkeren
        if (!selectedCell) {
          e.preventDefault();
          alert('Selecteer eerst een vrije locatie.');
          return;
        }

        // waardes uit het formulier halen
        const lotValue = lotSelect ? lotSelect.value : '';
        const qtyInput = form.querySelector('input[name="quantityKg"]:checked');
        const qtyValue = qtyInput ? qtyInput.value : '';

        // UI-update: geselecteerd vak wordt "occupied"
        selectedCell.classList.remove('selected');
        selectedCell.classList.remove('bb-free');
        selectedCell.classList.add('bb-occupied');
        selectedCell.setAttribute('data-status', 'occupied');

        const code  = selectedCell.getAttribute('data-code') || '';
        const inner = selectedCell.querySelector('.bb-slot-inner') || selectedCell;

        // lot-span aanmaken (als die nog niet bestaat)
        let lotSpan = inner.querySelector('.bb-slot-lot');
        if (!lotSpan) {
          lotSpan = document.createElement('span');
          lotSpan.className = 'bb-slot-lot';
          inner.appendChild(lotSpan);
        }

        // qty-span aanmaken (als die nog niet bestaat)
        let qtySpan = inner.querySelector('.bb-slot-qty');
        if (!qtySpan) {
          qtySpan = document.createElement('span');
          qtySpan.className = 'bb-slot-qty';
          inner.appendChild(qtySpan);
        }

        // teksten invullen
        lotSpan.textContent = lotValue;
        qtySpan.textContent = qtyValue ? qtyValue + ' kg' : '';

        // title-attribuut updaten (tooltip)
        let title = code;
        if (lotValue) {
          title += ' – ' + lotValue;
          if (qtyValue) {
            title += ' (' + qtyValue + ' kg)';
          }
        }
        selectedCell.setAttribute('title', title);

        // GEEN preventDefault: formulier mag gewoon submitten
        // naar /bb/discharge/print-label (nieuw tabblad)
      });
    }
  })();
</script>
