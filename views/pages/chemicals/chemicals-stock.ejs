<!-- views/pages/chemicals/chemicals-stock.ejs -->

<div class="card shadow-sm mb-4">
  <div class="card-header">
    <h1 style="margin-bottom:2px;">CHEMICALS â€¢ STOCK</h1>
    <span style="font-family:'Roboto Mono', monospace; font-size:10px; color:#646464;">
      Overview of the stock level and available batches. You can change the alert level.
    </span><br><br>
  </div>

  <div class="card-body">

    <style>
      /* Zelfde stijl als loading-table-compact */
      .chem-stock-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
      }

      .chem-stock-table thead tr {
        background: #f7f7f7;
      }

      .chem-stock-table th,
      .chem-stock-table td {
        padding: 7px 8px;
        border-bottom: 1px solid #e6e6e6;
        text-align: left;
        white-space: nowrap;
      }

      .chem-stock-table td.num {
        text-align: left;
      }

      .chem-stock-table .empty {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #777;
      }

      .chem-stock-green { color:#1a7f13; font-weight:bold; }
      .chem-stock-red   { color:#b30000; font-weight:bold; }

      .chem-alert-input {
        width: 60px;
        text-align: center;
        border: 1px solid #e0c36c;
        border-radius:9999px;
        background-color: #fff9c4;
        font-weight: bold;
        padding: 2px 4px;
        font-size:10px;
      }

      .chem-last-inbound {
        font-size: 10px;
        color: #555;
      }

      .chem-batch-row td {
        font-size: 10px;
      }
    </style>

    <div style="overflow:auto;">
      <table class="chem-stock-table">
        <thead>
          <tr>
            <th>ARTICLE</th>
            <th>STOCK LEVEL</th>
            <th>LAST INBOUND</th>
            <th>STOCK ALERT</th>
          </tr>
        </thead>
        <tbody>
          <% if (!stock || stock.length === 0) { %>
            <tr>
              <td colspan="4" class="empty">No articles found.</td>
            </tr>
          <% } else { %>

            <% stock.forEach(function(item) { %>
              <!-- Hoofd-rij per artikel -->
              <tr>
                <!-- ARTICLE -->
                <td>
                  <strong><%= item.articleId %> - <%= item.articleName %></strong>
                </td>

                <!-- STOCK LEVEL -->
                <td>
                  <% if (item.totalAvailable >= item.stockAlertValue) { %>
                    <span class="chem-stock-green"><%= item.totalAvailable %> in stock</span>
                  <% } else { %>
                    <span class="chem-stock-red"><%= item.totalAvailable %> in stock</span>
                  <% } %>
                </td>

                <!-- LAST INBOUND -->
                <td class="chem-last-inbound">
                  <% if (item.lastInboundQuantity != null && item.lastInboundDate) { %>
                    #<%= item.lastInboundQuantity %> on
                    <%= new Date(item.lastInboundDate).toLocaleDateString('nl-BE') %>
                  <% } else { %>
                    <span class="text-muted">No inbound yet</span>
                  <% } %>
                </td>

                <!-- STOCK ALERT (input + SAVE) -->
                <td>
                  <form action="/chemicals/stock/<%= item.articleId %>/alert"
                        method="POST"
                        style="margin:0; display:inline-flex; align-items:center; gap:6px;">
                    <input
                      type="number"
                      name="stockAlertValue"
                      value="<%= item.stockAlertValue %>"
                      min="0"
                      step="1"
                      class="chem-alert-input"
                    >
                    <button type="submit"
                            class="btn btn-dark btn-sm"
                            style="padding:6px 10px; font-size:9px; border-radius:9999px;">
                      SAVE
                    </button>
                  </form>
                </td>
              </tr>

              <!-- Extra rijen voor batches met >0 stock -->
              <% (item.batches || []).forEach(function(batch) { 
                   if (batch.availableQuantity > 0) { %>
                <tr class="chem-batch-row">
                  <!-- ARTICLE-kolom: lotnummer, ingesprongen -->
                  <td style="padding-left:22px;">
                    <%= batch.lotNumber %>
                  </td>

                  <!-- STOCK LEVEL: #aantal -->
                  <td>
                    #<%= batch.availableQuantity %>
                  </td>

                  <!-- LAST INBOUND & STOCK ALERT leeg voor batch-rijen -->
                  <td></td>
                  <td></td>
                </tr>
              <% } }); %>

            <% }); %>

          <% } %>
        </tbody>
      </table>
    </div>

  </div>
</div>
